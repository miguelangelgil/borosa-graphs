<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deuda Soberana / PIB por Pa√≠s</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background: #030712; }
    select { color-scheme: dark; }
  </style>
</head>
<body class="bg-gray-950 text-white p-4 min-h-screen">
  
  <h1 id="title" class="text-2xl font-bold mb-1">üìä Ratio Deuda Soberana / PIB</h1>
  <p id="subtitle" class="text-gray-400 text-sm mb-4">Cargando datos...</p>
  
  <div class="flex gap-4 mb-4 flex-wrap">
    <div>
      <label class="text-sm text-gray-400 mr-2">A√±o:</label>
      <select id="yearSelect" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm"></select>
    </div>
    <div>
      <label class="text-sm text-gray-400 mr-2">Regi√≥n:</label>
      <select id="regionSelect" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm"></select>
    </div>
    <div>
      <label class="text-sm text-gray-400 mr-2">Ordenar:</label>
      <select id="sortSelect" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
        <option value="debt">Por deuda</option>
        <option value="alpha">Alfab√©tico</option>
      </select>
    </div>
  </div>

  <div id="legend" class="flex gap-3 mb-4 flex-wrap text-xs"></div>

  <div id="chartContainer" style="height: 2500px;">
    <canvas id="chart"></canvas>
  </div>

  <div class="mt-4 text-xs text-gray-500 space-y-1">
    <p>‚Ä¢ L√≠nea verde: 60% (l√≠mite Pacto Estabilidad UE)</p>
    <p>‚Ä¢ L√≠nea amarilla: 100% del PIB</p>
    <p>‚Ä¢ Indicador: GGXWDG_NGDP (Deuda bruta gobierno general)</p>
  </div>

  <footer class="mt-8 pt-4 border-t border-gray-800 text-xs text-gray-600">
    <p>Datos actualizados autom√°ticamente v√≠a GitHub Actions ¬∑ 
      <a href="https://github.com/miguelangelgil/borosa-graphs" class="text-blue-500 hover:underline">Ver repositorio</a>
    </p>
  </footer>

  <script>
    const regionColors = {
      "Asia": "#f59e0b",
      "Europa": "#3b82f6",
      "Am√©rica": "#10b981",
      "Latam": "#8b5cf6",
      "MENA": "#ef4444",
      "√Åfrica": "#6b7280",
      "Ocean√≠a": "#06b6d4"
    };

    let imfData = null;
    let chart = null;
    let currentYear = "2025";
    let currentRegion = "all";
    let currentSort = "debt";

    // Renderizar leyenda
    function renderLegend() {
      const legend = document.getElementById('legend');
      legend.innerHTML = Object.entries(regionColors).map(([region, color]) => 
        `<span class="flex items-center gap-1">
          <span class="w-3 h-3 rounded" style="background-color: ${color}"></span>
          ${region}
        </span>`
      ).join('');
    }

    // Filtrar y ordenar datos
    function getFilteredData() {
      let data = imfData.data[currentYear] || [];
      
      if (currentRegion !== "all") {
        data = data.filter(d => d.region === currentRegion);
      }
      
      if (currentSort === "debt") {
        data = [...data].sort((a, b) => b.debt - a.debt);
      } else {
        data = [...data].sort((a, b) => a.country.localeCompare(b.country));
      }
      
      return data;
    }

    // Actualizar gr√°fico
    function updateChart() {
      const data = getFilteredData();
      
      // Actualizar altura del contenedor
      const containerHeight = Math.max(400, data.length * 24 + 50);
      document.getElementById('chartContainer').style.height = containerHeight + 'px';
      
      // Actualizar subt√≠tulo
      const avgDebt = Math.round(data.reduce((sum, d) => sum + d.debt, 0) / data.length);
      document.getElementById('title').textContent = `üìä Ratio Deuda Soberana / PIB (${currentYear})`;
      document.getElementById('subtitle').textContent = 
        `Fuente: FMI DataMapper ¬∑ ${data.length} pa√≠ses ¬∑ Media: ${avgDebt}% ¬∑ Actualizado: ${imfData.metadata?.fetched_at?.split('T')[0] || 'N/A'}`;

      const chartData = {
        labels: data.map(d => d.country),
        datasets: [{
          label: 'Deuda/PIB %',
          data: data.map(d => d.debt),
          backgroundColor: data.map(d => regionColors[d.region] || '#888'),
          borderRadius: 4,
          barThickness: 18
        }]
      };

      if (chart) {
        chart.data = chartData;
        chart.options.plugins.annotation = getAnnotations();
        chart.update('none');
      } else {
        const ctx = document.getElementById('chart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'bar',
          data: chartData,
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#111827',
                borderColor: '#374151',
                borderWidth: 1,
                titleColor: '#fff',
                bodyColor: '#9ca3af',
                callbacks: {
                  label: (ctx) => {
                    const d = data[ctx.dataIndex];
                    return [`Deuda/PIB: ${d.debt}%`, `Regi√≥n: ${d.region}`];
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: { color: '#1f2937' },
                ticks: { 
                  color: '#9ca3af',
                  callback: v => v + '%'
                }
              },
              y: {
                grid: { display: false },
                ticks: { 
                  color: '#e5e7eb',
                  font: { size: 11 }
                }
              }
            }
          },
          plugins: [{
            id: 'refLines',
            beforeDraw: (chart) => {
              const ctx = chart.ctx;
              const xAxis = chart.scales.x;
              const yAxis = chart.scales.y;
              
              // L√≠nea 60%
              const x60 = xAxis.getPixelForValue(60);
              ctx.save();
              ctx.strokeStyle = '#22c55e';
              ctx.setLineDash([5, 5]);
              ctx.beginPath();
              ctx.moveTo(x60, yAxis.top);
              ctx.lineTo(x60, yAxis.bottom);
              ctx.stroke();
              
              // L√≠nea 100%
              const x100 = xAxis.getPixelForValue(100);
              ctx.strokeStyle = '#fbbf24';
              ctx.beginPath();
              ctx.moveTo(x100, yAxis.top);
              ctx.lineTo(x100, yAxis.bottom);
              ctx.stroke();
              ctx.restore();
            }
          }]
        });
      }
    }

    // Poblar selectores
    function populateSelectors() {
      const years = imfData.metadata?.available_years || [];
      const yearSelect = document.getElementById('yearSelect');
      yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
      yearSelect.value = currentYear = years[0] || "2025";

      const regions = ["all", ...new Set(imfData.data[currentYear]?.map(d => d.region) || [])].sort();
      const regionSelect = document.getElementById('regionSelect');
      regionSelect.innerHTML = regions.map(r => 
        `<option value="${r}">${r === "all" ? "Todas" : r}</option>`
      ).join('');
    }

    // Event listeners
    document.getElementById('yearSelect').addEventListener('change', (e) => {
      currentYear = e.target.value;
      updateChart();
    });

    document.getElementById('regionSelect').addEventListener('change', (e) => {
      currentRegion = e.target.value;
      updateChart();
    });

    document.getElementById('sortSelect').addEventListener('change', (e) => {
      currentSort = e.target.value;
      updateChart();
    });

    // Cargar datos
    fetch('./data/imf_debt_data.json')
      .then(res => {
        if (!res.ok) throw new Error('No se encontr√≥ el archivo de datos');
        return res.json();
      })
      .then(data => {
        imfData = data;
        renderLegend();
        populateSelectors();
        updateChart();
      })
      .catch(err => {
        document.getElementById('subtitle').innerHTML = 
          `<span class="text-red-400">Error: ${err.message}</span><br>
           <span class="text-gray-500">Ejecuta la GitHub Action para generar los datos.</span>`;
      });
  </script>
</body>
</html>